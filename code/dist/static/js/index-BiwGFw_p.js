import{i as T}from"./comm-DyJRlPK0.js";import{m as Y,d as L,i as q,b as Z,c as ee}from"./index-CyAmoSeV.js";import{u as O}from"./index-4ocppgba.js";import"./@wangeditor_plugin-link-card@1.0.0_@wangeditor_editor@5.1.23_snabbdom@3.6.2-D_kdJ7Fs.js";import"./@wangeditor_editor@5.1.23-BNs7_II4.js";import{S as oe,T as te}from"./@element-plus_icons-vue@2.3.1_vue@3.5.12_typescript@5.5.4_-DwlSpvcG.js";import"./store@2.0.12-RoMfFez2.js";import{c8 as ne,a as j}from"./lodash-es@4.17.21-D6PnhKvy.js";import{a as F}from"./element-plus@2.8.4_vue@3.5.12_typescript@5.5.4_-C7CHjwzj.js";import{d as w,_ as s,a as b,c as x,i as a,L as i,P as A,F as M,b as le,o as re,K as N,O as K,X as D,a0 as ae,M as se}from"./@vue_runtime-core@3.5.12-Bt7zQ28n.js";import{r as pe,v as S}from"./@vue_reactivity@3.5.12-vtUNgENk.js";import{d as ie}from"./dayjs@1.11.13-DXimfR00.js";import{u as ue,a as me}from"./menu-CKmUdZXU.js";import{O as R}from"./@vue_shared@3.5.12-UFe9jxSY.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./@braintree_sanitize-url@6.0.4-BB1FEM6a.js";import"./vue@3.5.12_typescript@5.5.4-kKmasoJt.js";import"./@vue_runtime-dom@3.5.12-iSYHT88p.js";import"./@vueuse_core@11.1.0_vue@3.5.12_typescript@5.5.4_-BKaerpSy.js";import"./@vueuse_shared@11.1.0_vue@3.5.12_typescript@5.5.4_-DXriuop5.js";import"./mitt@3.0.1-C1z4c41a.js";import"./axios@1.7.7-CCb-kr4I.js";import"./nprogress@0.2.0-B8S133N7.js";import"./pinia@2.2.4_typescript@5.5.4_vue@3.5.12_typescript@5.5.4_-CVf9nHlw.js";import"./vue-demi@0.14.10_vue@3.5.12_typescript@5.5.4_-DvPnGcuI.js";import"./@bytemd_plugin-math@1.21.0_bytemd@1.21.0-Dc_JUVYX.js";import"./remark-math@5.1.1-C8vps_rM.js";import"./micromark-extension-math@2.1.2-StTlgfH1.js";import"./micromark-factory-space@1.1.0-C57A7NS2.js";import"./micromark-util-character@1.2.0-D-NaLusr.js";import"./katex@0.16.11-CvgdMzdh.js";import"./mdast-util-math@2.0.2-Boy2OOKg.js";import"./longest-streak@3.1.0-BHNUWYJP.js";import"./mdast-util-to-markdown@1.5.0-D9VzXa1u.js";import"./micromark-util-decode-string@1.1.0-CdHYbWAu.js";import"./decode-named-character-reference@1.0.2-C3-224fz.js";import"./micromark-util-decode-numeric-character-reference@1.1.0-DRnCnno4.js";import"./vue-router@4.4.5_vue@3.5.12_typescript@5.5.4_-DGEeQixy.js";import"./mockjs@1.1.0-hXCvQ4kl.js";import"./vue-echarts@7.0.3_@vue_runtime-core@3.5.12_echarts@5.5.1_vue@3.5.12_typescript@5.5.4_-tmE62Ovn.js";import"./echarts@5.5.1-D8FyPvXx.js";import"./tslib@2.3.0-BDyQ-Jie.js";import"./zrender@5.6.0-CH1asNwC.js";import"./@vueuse_shared@9.13.0_vue@3.5.12_typescript@5.5.4_-u9BR5ga7.js";import"./@vueuse_core@9.13.0_vue@3.5.12_typescript@5.5.4_-B3H9WZsa.js";import"./@sxzz_popperjs-es@2.11.7-DkudPAZk.js";import"./@ctrl_tinycolor@3.6.1--gef7wIN.js";import"./async-validator@4.2.5-DbzRl2Zc.js";import"./memoize-one@6.0.0-DQFWdy6B.js";import"./normalize-wheel-es@1.2.0-D2sExr9L.js";import"./@floating-ui_dom@1.6.11-Db5K7U0i.js";import"./@floating-ui_core@1.6.8-B67JZAQv.js";import"./@floating-ui_utils@0.2.8-BSxVqCX2.js";import"./lodash-unified@1.0.3_@types_lodash-es@4.17.12_lodash-es@4.17.21_lodash@4.17.21-D8rsWRp7.js";const de=w({name:"undefined"}),_e=w({...de,setup($){const{service:y}=O(),g=T.useForm(),k=T.useCrud(),_=pe(!1);function v(h,f){_.value=!0;const d=new FileReader;d.onload=u=>{var r,n;_.value=!1;try{const t=JSON.parse((r=u.target)==null?void 0:r.result);(n=g.value)==null||n.open({title:"菜单导入",height:"400px",width:"600px",props:{labelWidth:"0px"},op:{saveButtonText:"添加"},items:[{component:{name:"slot-tips"}},{component:{name:"el-tree",props:{data:ne(t,"orderNum","asc"),nodeKey:"name",props:{label:"name",children:"childMenus"},renderContent(e,{data:o}){return o.name}},style:{padding:"5px",borderRadius:"var(--el-border-radius-base)",border:"1px solid var(--el-border-color)"}}}],on:{submit(e,{close:o,done:p}){y.base.sys.menu.import({menus:t}).then(()=>{var m;F.success("导入成功"),(m=k.value)==null||m.refresh(),o()}).catch(m=>{F.error(m.message),p()})}}})}catch(t){F.error(`${f.name}文件格式错误：${t}`)}},d.readAsText(f)}return(h,f)=>{const d=s("el-button"),u=s("cl-upload"),r=s("el-alert"),n=s("cl-form");return b(),x(M,null,[a(u,{type:"file","show-file-list":!1,"auto-upload":!1,disabled:_.value,onUpload:v},{default:i(()=>[a(d,{type:"success",icon:S(oe),loading:_.value},{default:i(()=>f[0]||(f[0]=[A("导入")])),_:1},8,["icon","loading"])]),_:1},8,["disabled"]),a(n,{ref_key:"Form",ref:g},{"slot-tips":i(()=>[a(r,{type:"warning"},{default:i(()=>f[1]||(f[1]=[A("如遇到问题无法导入菜单，请检查文件并尝试重新导入。")])),_:1})]),_:1},512)],64)}}}),fe=w({name:"undefined"}),be=w({...fe,props:{data:{type:Array,default:()=>[]}},setup($){const y=$,{service:g,refs:k,setRefs:_}=O(),v=T.useForm();function h(){var f;(f=v.value)==null||f.open({title:"导出",width:"600px",props:{labelPosition:"top"},op:{saveButtonText:"导出"},items:[{label:"选择菜单",prop:"ids",component:{name:"el-tree-select",ref:_("ids"),props:{data:y.data,nodeKey:"id",multiple:!0,showCheckbox:!0,collapseTags:!0,collapseTagsTooltip:!0,props:{label:"name"}}}}],on:{submit(d,{done:u,close:r}){const n=[...k.ids.getCheckedKeys(),...k.ids.getHalfCheckedKeys()];j(n)?(F.warning("请先选择要导出的菜单"),u()):g.base.sys.menu.export({ids:n}).then(t=>{r();const e=new Blob([JSON.stringify(t)],{type:"application/json"}),o=URL.createObjectURL(e),p=document.createElement("a");p.href=o,p.download=`菜单数据 ${ie().format("MM-DD HH_mm_ss")}.json`,p.click(),URL.revokeObjectURL(o)}).catch(t=>{F.error(t.message)})}}})}return(f,d)=>{const u=s("el-button"),r=s("cl-form");return b(),x(M,null,[a(u,{type:"info",icon:S(te),onClick:h},{default:i(()=>d[0]||(d[0]=[A("导出")])),_:1},8,["icon"]),a(r,{ref_key:"Form",ref:v},null,512)],64)}}}),he=w({name:"menu-create"}),ye=w({...he,setup($){const{service:y,mitt:g}=O(),k=me(),_=T.useForm(),v=ue(),h=[],f=le(()=>L(h.map(r=>r.value)));function d(){var r;(r=_.value)==null||r.open({title:"快速创建",width:"800px",items:[{prop:"module",label:"选择模块",span:10,component:{name:"cl-select",props:{filterable:!0,clearable:!0,placeholder:"请选择模块",allowCreate:!0,defaultFirstOption:!0,options:Y.dirs}},required:!0},{prop:"entity",label:"数据结构",span:14,component:{name:"slot-entity"},required:!0},{prop:"name",label:"菜单名称",span:10,component:{name:"el-input",props:{placeholder:"请输入菜单名称"}},required:!0},{prop:"router",label:"菜单路由",span:14,component:{name:"el-input",props:{placeholder:"请输入菜单路由，如：/test"}},rules:{required:!0,validator(n,t,e){(t||"").startsWith("/")?e():e(new Error("必须以 / 开头"))}}},{prop:"parentId",label:"上级节点",component:{name:"cl-menu-select",props:{type:1}}},{prop:"keepAlive",value:!0,label:"路由缓存",component:{name:"el-radio-group",options:[{label:"开启",value:!0},{label:"关闭",value:!1}]}},{prop:"icon",label:"菜单图标",component:{name:"cl-menu-icon"}},{prop:"orderNum",label:"排序号",component:{name:"el-input-number",props:{placeholder:"请填写排序号",min:0,max:99,"controls-position":"right"}}},{prop:"isCreateFile",label:"是否创建文件",value:1,component:{name:"el-radio-group",options:[{label:"是",value:1},{label:"否",value:0}]}},{prop:"isAi",label:"是否AI分析",value:1,component:{name:"el-radio-group",options:[{label:"是",value:1},{label:"否",value:0}]},hidden({scope:n}){return n.isCreateFile==0}}],on:{async submit(n,{done:t,close:e}){const{api:o,prefix:p,columns:m}=h.find(c=>c.value==n.entity.join("/"));n.isAi&&await v.invokeFlow("comm-parse-column",{entity:JSON.stringify(m)}).then(c=>{m.forEach(V=>{V.component=c.columns[V.propertyName]||"input"})}),k.create({...n,router:n.router,module:n.module,prefix:p,api:o,columns:m}).then(c=>{n.isCreateFile&&c(),g.emit("helper.createMenu"),e()}).catch(c=>{console.error(c),t()})}}})}function u(r){var t;const n=h.find(e=>e.value==r.join("/"));n&&((t=_.value)==null||t.setForm("router",`/${n.value}`))}return re(()=>{y.base.open.eps().then(r=>{for(const n in r)r[n].forEach(t=>{j(t.columns)||h.push({value:t.prefix.substring(7),...t})})})}),(r,n)=>{const t=s("el-button"),e=s("el-cascader"),o=s("cl-form");return b(),x(M,null,[a(t,{type:"success",onClick:d},{default:i(()=>n[0]||(n[0]=[A("快速创建")])),_:1}),a(o,{ref_key:"Form",ref:_},{"slot-entity":i(({scope:p})=>[a(e,{modelValue:p.entity,"onUpdate:modelValue":m=>p.entity=m,filterable:"",separator:".",options:f.value,onChange:u},null,8,["modelValue","onUpdate:modelValue","options"])]),_:1},512)],64)}}}),ve=w({name:"auto-menu"}),we=w({...ve,setup($){return(y,g)=>S(q)?(b(),N(ye,{key:0})):K("",!0)}}),ge=w({name:"auto-perms"}),ke=w({...ge,props:{menuId:[String,Number]},emits:["open","close"],setup($,{emit:y}){const g=$,k=y,{service:_}=O(),v=T.useForm();async function h(){return _.base.open.eps().then(d=>{const u=[],r=[];for(const n in d)d[n].forEach(t=>{var e;t.prefix=(e=t.prefix)==null?void 0:e.replace("/admin/",""),t.prefix&&r.push(t.prefix),u.push(t)});return{prop:"entity",label:"实体数据",component:{name:"el-cascader",props:{options:L(r),separator:".",props:{multiple:!0},onChange(n){var e;const t=[];n.forEach(o=>{const p=u.find(m=>m.prefix==o.join("/"));p&&(p.api.forEach(m=>{m.perms=(p.prefix+m.path).replace(/\//g,":"),m.checked=!0}),t.push(p))}),(e=v.value)==null||e.setForm("list",t)}}}}})}async function f(){var d;k("open"),(d=v.value)==null||d.open({title:"自动添加权限",width:"800px",dialog:{draggable:!0,controls:["close"]},props:{labelPosition:"top"},op:{saveButtonText:"一键添加"},items:[await h(),{prop:"list",label:"权限列表",value:[],hidden({scope:u}){return!u.entity},component:{name:"slot-list"}}],on:{submit(u,{done:r,close:n}){if(!u.entity){F.error("请选择实体数据"),r();return}const t=u.list.map(e=>e.api).flat().filter(e=>e.checked);if(t.find(e=>!e.summary)){F.error("请填写权限名称"),r();return}if(t.length==0){F.error("请至少选择一个权限"),r();return}Promise.all(t.map(e=>_.base.sys.menu.add({type:2,parentId:g.menuId,name:e.summary,perms:e.perms}))).then(()=>{F.success("添加权限成功"),n(),k("close")}).catch(e=>{r(),F.error(e.message)})}}})}return(d,u)=>{const r=s("el-button"),n=s("el-divider"),t=s("el-switch"),e=s("el-input"),o=s("cl-menu-perms"),p=s("el-scrollbar"),m=s("cl-form");return b(),x(M,null,[S(q)?(b(),N(r,{key:0,style:{"margin-left":"10px"},onClick:f},{default:i(()=>u[0]||(u[0]=[A("自动添加")])),_:1})):K("",!0),a(m,{ref_key:"Form",ref:v},{"slot-list":i(({scope:c})=>[a(p,{class:"scrollbar"},{default:i(()=>[(b(!0),x(M,null,D(c.list,(V,E)=>(b(),x("div",{key:E,class:"list"},[a(n,{"content-position":"left"},{default:i(()=>[A(R(V.prefix),1)]),_:2},1024),(b(!0),x(M,null,D(V.api,(C,P)=>(b(),x("div",{key:P,class:"item"},[a(t,{modelValue:C.checked,"onUpdate:modelValue":I=>C.checked=I},null,8,["modelValue","onUpdate:modelValue"]),a(e,{modelValue:C.summary,"onUpdate:modelValue":I=>C.summary=I,clearable:"",placeholder:"权限名称",disabled:!C.checked},null,8,["modelValue","onUpdate:modelValue","disabled"]),a(o,{modelValue:C.perms,"onUpdate:modelValue":I=>C.perms=I,disabled:!C.checked},null,8,["modelValue","onUpdate:modelValue","disabled"])]))),128))]))),128))]),_:2},1024)]),_:1},512)],64)}}}),xe=ce(ke,[["__scopeId","data-v-5a877d1c"]]),Ve={key:1},Ce={key:1},Ue={key:1},Fe=w({name:"sys-menu"}),Ao=w({...Fe,setup($){const{service:y,mitt:g}=O(),{menu:k}=Z(),_=T.useTable({contextMenu:[e=>({label:"新增",hidden:!(e.type!=2&&y.base.sys.user._permission.add),callback(o){n(e),o()}}),"update","delete",e=>({label:"权限",hidden:!(e.type!=2&&y.base.sys.user._permission.add),callback(o){t(e),o()}})],columns:[{type:"selection"},{prop:"name",label:"名称",align:"left",width:200,fixed:"left"},{prop:"isShow",label:"是否显示",width:100},{prop:"icon",label:"图标",width:100},{prop:"type",label:"类型",width:100,dict:[{label:"目录",value:0,type:"warning"},{label:"菜单",value:1,type:"success"},{label:"权限",value:2,type:"danger"}]},{prop:"router",label:"节点路由",minWidth:170},{prop:"keepAlive",label:"路由缓存",width:100},{prop:"viewPath",label:"文件路径",minWidth:200,showOverflowTooltip:!0},{prop:"perms",label:"权限",headerAlign:"center",minWidth:300,dict:[]},{prop:"orderNum",label:"排序号",width:90,fixed:"right"},{prop:"updateTime",label:"更新时间",sortable:"custom",width:170},{label:"操作",type:"op",width:250,buttons:["slot-add","edit","delete"]}]}),v=T.useUpsert({dialog:{width:"800px"},items:[{prop:"type",value:0,label:"节点类型",required:!0,component:{name:"el-radio-group",options:[{label:"目录",value:0},{label:"菜单",value:1},{label:"权限",value:2}]}},{prop:"name",label:"节点名称",component:{name:"el-input"},required:!0},{prop:"parentId",label:"上级节点",hook:{submit(e){return e||null}},component:{name:"slot-parentId"}},{prop:"router",label:"节点路由",hidden:({scope:e})=>e.type!=1,component:{name:"el-input",props:{placeholder:"请输入节点路由，如：/test"}}},{prop:"keepAlive",value:!0,label:"路由缓存",hidden:({scope:e})=>e.type!=1,component:{name:"el-radio-group",options:[{label:"开启",value:!0},{label:"关闭",value:!1}]}},{prop:"isShow",label:"是否显示",value:!0,hidden:({scope:e})=>e.type==2,flex:!1,component:{name:"el-switch"}},{prop:"viewPath",label:"文件路径",hidden:({scope:e})=>e.type!=1,component:{name:"cl-menu-file"}},{prop:"icon",label:"节点图标",hidden:({scope:e})=>e.type==2,component:{name:"cl-menu-icon"}},{prop:"orderNum",label:"排序号",component:{name:"el-input-number",props:{placeholder:"请填写排序号",min:0,max:99,"controls-position":"right"}}},{prop:"perms",label:"权限",hidden:({scope:e})=>e.type!=2,component:{name:"slot-perms"}}],plugins:[T.setFocus("name")]}),h=T.useCrud({service:y.base.sys.menu,onRefresh(e,{render:o}){y.base.sys.menu.list().then(p=>{o(d(p)),k.get()})}},e=>{e.refresh()});function f(e){var o;(o=h.value)==null||o.refresh(e)}function d(e){const o=ee(e),p=m=>{m.forEach(c=>{var E;const V=((E=_.value)==null?void 0:E.Table.store.states.lazyTreeNodeMap.value)||{};V[c.id]&&(V[c.id]=c.children||[]),j(c.children)||(c.hasChildren=!0,c._children=c.children,delete c.children,p(c._children||[]))})};return p(o),o}function u(e,o,p){p(e._children||[])}function r(e){var o;e._children&&((o=_.value)==null||o.Table.store.loadOrToggle(e))}function n({type:e=0,id:o}){var p;(p=h.value)==null||p.rowAppend({parentId:o,parentType:e,type:e+1,keepAlive:!0,isShow:!0})}function t({id:e}){var o;(o=h.value)==null||o.rowAppend({parentId:e,type:2})}return g.on("helper.createMenu",f),(e,o)=>{const p=s("cl-refresh-btn"),m=s("cl-add-btn"),c=s("cl-multi-delete-btn"),V=s("cl-flex1"),E=s("cl-row"),C=s("cl-svg"),P=s("cl-switch"),I=s("el-link"),W=s("el-button"),z=s("cl-table"),H=s("cl-menu-select"),J=s("cl-menu-perms"),X=s("cl-upsert"),G=s("cl-crud"),Q=ae("permission");return b(),N(G,{ref_key:"Crud",ref:h},{default:i(()=>[a(E,null,{default:i(()=>{var l;return[a(p),a(m),a(c),a(we),a(V),a(_e),a(be,{data:(l=S(_))==null?void 0:l.data},null,8,["data"])]}),_:1}),a(E,null,{default:i(()=>[a(z,{ref_key:"Table",ref:_,"row-key":"id",lazy:"",load:u,"tree-props":{children:"children",hasChildren:"hasChildren"},onRowClick:r},{"column-icon":i(({scope:l})=>[a(C,{name:l.row.icon,size:"16px",style:{"margin-top":"5px"}},null,8,["name"])]),"column-isShow":i(({scope:l})=>[l.row.type!=2?(b(),N(P,{key:0,modelValue:l.row.isShow,"onUpdate:modelValue":U=>l.row.isShow=U,scope:l.row,column:l.column},null,8,["modelValue","onUpdate:modelValue","scope","column"])):(b(),x("span",Ve))]),"column-keepAlive":i(({scope:l})=>[l.row.type==1?(b(),N(P,{key:0,modelValue:l.row.keepAlive,"onUpdate:modelValue":U=>l.row.keepAlive=U,scope:l.row,column:l.column},null,8,["modelValue","onUpdate:modelValue","scope","column"])):(b(),x("span",Ce))]),"column-router":i(({scope:l})=>[l.row.type==1?(b(),N(I,{key:0,type:"success",href:l.row.router},{default:i(()=>[A(R(l.row.router),1)]),_:2},1032,["href"])):(b(),x("span",Ue,R(l.row.router),1))]),"slot-add":i(({scope:l})=>[se((b(),N(W,{type:"success",text:"",bg:"",onClick:U=>n(l.row)},{default:i(()=>o[2]||(o[2]=[A(" 新增 ")])),_:2},1032,["onClick"])),[[Q,{and:[S(y).base.sys.menu.permission.add,l.row.type!=2]}]])]),_:1},512)]),_:1}),a(X,{ref_key:"Upsert",ref:v},{"slot-parentId":i(({scope:l})=>[a(H,{modelValue:l.parentId,"onUpdate:modelValue":U=>l.parentId=U,type:l.type},null,8,["modelValue","onUpdate:modelValue","type"])]),"slot-perms":i(({scope:l})=>[a(J,{modelValue:l.perms,"onUpdate:modelValue":U=>l.perms=U},null,8,["modelValue","onUpdate:modelValue"]),a(xe,{"menu-id":l.parentId,onOpen:o[0]||(o[0]=U=>{var B;return(B=S(v))==null?void 0:B.close()}),onClose:o[1]||(o[1]=U=>f())},null,8,["menu-id"])]),_:1},512)]),_:1},512)}}});export{Ao as default};
